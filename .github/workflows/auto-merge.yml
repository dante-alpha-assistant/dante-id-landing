name: Auto-merge

on:
  workflow_run:
    workflows: ["Smoke Test"]
    types: [completed]

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'pull_request'

    steps:
      - name: Check auto-merge guard
        id: guard
        run: |
          if [ "${{ secrets.AUTO_MERGE_ENABLED }}" = "false" ]; then
            echo "Auto-merge is disabled via AUTO_MERGE_ENABLED secret"
            echo "enabled=false" >> $GITHUB_OUTPUT
          else
            echo "enabled=true" >> $GITHUB_OUTPUT
          fi

      - name: Get PR number
        if: steps.guard.outputs.enabled == 'true'
        id: pr
        run: |
          # Get the PR associated with this workflow run
          PR_DATA=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.GH_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}/pull_requests")

          PR_NUMBER=$(echo "$PR_DATA" | jq -r '.[0].number // empty')
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT

          if [ -z "$PR_NUMBER" ]; then
            echo "No PR found for this workflow run"
            exit 0
          fi
          echo "Found PR #$PR_NUMBER"

      - name: Auto-merge PR
        if: steps.guard.outputs.enabled == 'true' && steps.pr.outputs.pr_number != ''
        run: |
          PR_NUMBER=${{ steps.pr.outputs.pr_number }}

          # Merge the PR
          MERGE_RESULT=$(curl -s -w "%{http_code}" -o /tmp/merge_response.json \
            -X PUT \
            -H "Authorization: Bearer ${{ secrets.GH_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER/merge" \
            -d '{"merge_method": "squash", "commit_title": "Auto-merge PR #'"$PR_NUMBER"' (CI passed)"}')

          echo "Merge response: $MERGE_RESULT"
          cat /tmp/merge_response.json | jq .

          if [ "$MERGE_RESULT" = "200" ]; then
            echo "✅ PR #$PR_NUMBER auto-merged"
          else
            echo "⚠️ Could not merge PR #$PR_NUMBER (HTTP $MERGE_RESULT)"
          fi

      - name: Trigger deploy
        if: steps.guard.outputs.enabled == 'true' && steps.pr.outputs.pr_number != ''
        run: |
          # Trigger Vercel deploy via deploy hook or CLI
          echo "Deploy triggered after auto-merge"
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
